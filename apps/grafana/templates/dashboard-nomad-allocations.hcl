variable "dashboard_nomad_allocations" {
  default = <<-EOH
{"annotations":{"list":[{"builtIn":1,"datasource":{"type":"grafana","uid":"-- Grafana --"},"enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations & Alerts","target":{"limit":100,"matchAny":false,"tags":[],"type":"dashboard"},"type":"dashboard"}]},"description":"Monitor resource metrics like CPU, Memory and Disk for each allocation across namespaces in a Nomad cluster.","editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"links":[],"panels":[{"collapsed":false,"gridPos":{"h":1,"w":24,"x":0,"y":0},"id":10,"panels":[],"title":"CPU","type":"row"},{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"barWidthFactor":0.6,"drawStyle":"line","fillOpacity":46,"gradientMode":"hue","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","showValues":false,"spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"max":1,"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"green","value":0},{"color":"red","value":80}]},"unit":"percentunit"},"overrides":[]},"gridPos":{"h":8,"w":24,"x":0,"y":1},"id":21,"options":{"legend":{"calcs":["lastNotNull","max","mean"],"displayMode":"table","placement":"right","showLegend":true,"sortBy":"Last *","sortDesc":true},"tooltip":{"hideZeros":false,"mode":"single","sort":"none"}},"pluginVersion":"12.3.0","targets":[{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"editorMode":"code","expr":"sum by (task,alloc_id)(nomad_client_allocs_cpu_total_ticks{exported_job=\"$workload\",task_group=\"$group\"}) / sum by (task,alloc_id)(nomad_client_allocs_cpu_allocated{exported_job=\"$workload\",task_group=\"$group\"})","legendFormat":"{{task}} - {{alloc_id}}","range":true,"refId":"A"}],"title":"CPU %","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"description":"Total CPU resources consumed by the task across all cores","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"barWidthFactor":0.6,"drawStyle":"line","fillOpacity":50,"gradientMode":"hue","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","showValues":false,"spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"green","value":0},{"color":"red","value":80}]},"unit":"short"},"overrides":[]},"gridPos":{"h":8,"w":12,"x":0,"y":9},"id":19,"options":{"legend":{"calcs":["lastNotNull","max","mean"],"displayMode":"table","placement":"right","showLegend":true,"sortBy":"Last *","sortDesc":true},"tooltip":{"hideZeros":false,"mode":"single","sort":"none"}},"pluginVersion":"12.3.0","targets":[{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"editorMode":"code","expr":"sum by (task,alloc_id)(nomad_client_allocs_cpu_total_percent{exported_job=\"$workload\",task_group=\"$group\"})/100","legendFormat":"{{task}} - {{alloc_id}}","range":true,"refId":"A"}],"title":"CPU Usage (Cores) ","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"description":"Total time that the task was throttled","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"barWidthFactor":0.6,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","showValues":false,"spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"green","value":0},{"color":"red","value":80}]},"unit":"ns"},"overrides":[]},"gridPos":{"h":8,"w":12,"x":12,"y":9},"id":23,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"bottom","showLegend":true},"tooltip":{"hideZeros":false,"mode":"single","sort":"none"}},"pluginVersion":"12.3.0","targets":[{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"editorMode":"code","expr":"sum by (task,alloc_id)(nomad_client_allocs_cpu_throttled_time{exported_job=\"$workload\",task_group=\"$group\"})","legendFormat":"{{task}} - {{alloc_id}}","range":true,"refId":"A"}],"title":"CPU Throttled Time ","type":"timeseries"},{"collapsed":false,"gridPos":{"h":1,"w":24,"x":0,"y":17},"id":12,"panels":[],"title":"Memory","type":"row"},{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisBorderShow":false,"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"auto","barAlignment":0,"barWidthFactor":0.6,"drawStyle":"line","fillOpacity":38,"gradientMode":"hue","hideFrom":{"legend":false,"tooltip":false,"viz":false},"insertNulls":false,"lineInterpolation":"linear","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","showValues":false,"spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"max":1,"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"green","value":0},{"color":"red","value":80}]},"unit":"percentunit"},"overrides":[]},"gridPos":{"h":9,"w":24,"x":0,"y":18},"id":25,"options":{"legend":{"calcs":["lastNotNull","max","mean"],"displayMode":"table","placement":"right","showLegend":true},"tooltip":{"hideZeros":false,"mode":"single","sort":"none"}},"pluginVersion":"12.3.0","targets":[{"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"editorMode":"code","expr":"sum by (task,alloc_id)(nomad_client_allocs_memory_usage{exported_job=\"$workload\",task_group=\"$group\"}) / sum by (task,alloc_id)(nomad_client_allocs_memory_allocated{exported_job=\"$workload\",task_group=\"$group\"})","legendFormat":"{{task}} - {{alloc_id}}","range":true,"refId":"A"}],"title":"Memory %","type":"timeseries"}],"preload":false,"refresh":"","schemaVersion":42,"tags":["nomad","nomad-allocs"],"templating":{"list":[{"current":{"text":"VictoriaMetrics","value":"P4169E866C3094E38"},"includeAll":false,"label":"datasource","name":"DS_PROMETHEUS","options":[],"query":"prometheus","refresh":1,"regex":"","type":"datasource"},{"current":{"text":"grafana","value":"grafana"},"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"definition":"label_values(nomad_client_allocs_cpu_allocated{}, exported_job)","includeAll":false,"label":"Workload","name":"workload","options":[],"query":{"query":"label_values(nomad_client_allocs_cpu_allocated{}, exported_job)","refId":"StandardVariableQuery"},"refresh":1,"regex":"","type":"query"},{"current":{"text":"grafana","value":"grafana"},"datasource":{"type":"prometheus","uid":"P4169E866C3094E38"},"definition":"label_values(nomad_client_allocs_cpu_allocated{exported_job=\"$workload\"}, task_group)","includeAll":false,"label":"Task Group","name":"group","options":[],"query":{"query":"label_values(nomad_client_allocs_cpu_allocated{exported_job=\"$workload\"}, task_group)","refId":"StandardVariableQuery"},"refresh":1,"regex":"","type":"query"}]},"time":{"from":"now-6h","to":"now"},"timepicker":{},"timezone":"","title":"Nomad Allocations","uid":"5XxwU0GVz","weekStart":""}
EOH
}
